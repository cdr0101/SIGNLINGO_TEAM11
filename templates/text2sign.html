{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="split left">
    <h2 align="center">Input Zone: Text or Vocalize</h2>
    <br>
    <form action="" method="post" align="left" id="inputForm">
        {% csrf_token %}
        <label for="language" style="font-size: 20px; font-weight: bold; margin-left: 16px;">Choose Language:</label>
        <select id="language" name="language" style="font-size: 18px; margin-bottom: 10px; padding: 1px 1px 1px 1px; border: 3px solid #104d45;">
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="zh">Chinese</option>
            <option value="hi">Hindi</option>
            <option value="ar">Arabic</option>
            <option value="ru">Russian</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
            <option value="ko">Punjabi</option>
            <option value="ko">Marathi</option>
        </select>
        <br> <br>
        <input type="text" name="sen" class="mytext" id="speechToText" placeholder="Enter text" style="font-size: 20px; width: 50%; ">
        <button type="button" name="button" class="mic" onclick="record()" style="font-size: 16px; width: 60px;">
            <img src="{% static 'mic3.png' %}" height="32px" width="35px" />
        </button>

        <input type="submit" name="submit" class="submit" value="Submit" style="font-size: 22px; font-weight: bold;">
    </form>
    <br>
    <table cellspacing="20px">
        <tr>
            <td class="td">Emotion Detected:</td>
            <td class="td">{{ emotion_label }} {{ emotion_emoji }} </td>
        </tr>
        <tr>
            <td class="td">Translated Text:</td>
            <td class="td">{{ text }}</td>
        </tr>
        <tr>
            <td class="td">Message Captured:</td>
            <td class="td">{{ text }}</td>
        </tr>
        <tr>
            <td class="td">Key Words:</td>
            <td class="td">
                <ul class="td" id="list" align="left">
                    {% for word in words %}
                        <li id="{{ forloop.counter }}" style="margin-right: 2px">{{ word }}</li>
                    {% endfor %}
                </ul>
            </td>
        </tr>
    </table>    
</div>
<div class="split right">
    <h2 align="center">Sign Language Generated</h2>
    <div style="text-align:center">
        &nbsp&nbsp
        <button class="submit" style="font-size: 22px; font-weight: bold;" onclick="playPause()">Play/Pause</button>
        <video id="videoPlayer" width="600" height="350" preload="auto">
            <source src="" type="video/mp4">
            Your browser does not support HTML5 video.
        </video>
    </div>
</div>

<script>
    function record() {
        var recognition = new webkitSpeechRecognition();
        const language = document.getElementById('language').value;
        recognition.lang = language === 'en' ? 'en-IN' : language;

        recognition.onresult = async function(event) {
            console.log(event);
            const spokenText = event.results[0][0].transcript;
            document.getElementById('speechToText').value = spokenText;

            if (language !== 'en' && spokenText) {
                const translatedText = await getTranslation(spokenText, language);
                document.getElementById('speechToText').value = translatedText;
            }
        }
        recognition.start();
    }

    async function getTranslation(text, sourceLanguage) {
        try {
            const response = await fetch('https://libretranslate.de/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    q: text,
                    source: sourceLanguage,
                    target: 'en',
                    format: 'text'
                }),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data.translatedText;
        } catch (error) {
            console.error('Error during translation:', error);
            return text;  // Return original text if translation fails
        }
    }

    function play() {
        var videoSource = [];
        var videos = document.getElementById("list").getElementsByTagName("li");
        var j;
        for (j = 0; j < videos.length; j++) {
            videoSource[j] = "/static/" + videos[j].innerHTML + ".mp4";
            console.log(videoSource[j]);
        }
        var i = 0;
        var videoCount = videoSource.length;

        function videoPlay(videoNum) {
            document.getElementById("list").getElementsByTagName("li")[videoNum].style.color = "#09edc7";
            document.getElementById("list").getElementsByTagName("li")[videoNum].style.fontSize = "xx-large";
            document.getElementById("videoPlayer").setAttribute("src", videoSource[videoNum]);
            document.getElementById("videoPlayer").load();
            document.getElementById("videoPlayer").play();
        }

        function myHandler() {
            document.getElementById("list").getElementsByTagName("li")[i].style.color = "#be66e7";
            document.getElementById("list").getElementsByTagName("li")[i].style.fontSize = "20px";
            i++;
            if (i == videoCount) {
                document.getElementById("videoPlayer").pause();
            } else {
                videoPlay(i);
            }
        }

        document.getElementById('videoPlayer').addEventListener('ended', myHandler, false);
        document.getElementById("list").getElementsByTagName("li")[0].style.color = "#09edc7";
        document.getElementById("list").getElementsByTagName("li")[0].style.fontSize = "xx-large";

        videoPlay(0);
    }

    function playPause() {
        if (document.getElementById("videoPlayer").paused) {
            play();
        } else {
            document.getElementById("videoPlayer").pause();
        }
    }
</script>

{% endblock %}
